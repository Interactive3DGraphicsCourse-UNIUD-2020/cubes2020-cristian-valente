<html>
	<head>
		<title>Starting Code for 1st Project 2017</title>
		<style>

		body {
			font-family: Monospace;
			background-color: #97DBD1;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}

	</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/Coordinates.js"></script>
		<script src="lib/OrbitControls.js"></script>
	</head>
	<body>

		<script>

		var scene, camera, renderer, controls, stats;
		var angle, sea, coast, foam;
		var time,clock;

		//return array with height data from img, taken from: http://danni-three.blogspot.it/2013/09/threejs-heightmaps.html
		function getHeightData(img,scale) {

		 if (scale == undefined) scale=1;

		    var canvas = document.createElement( 'canvas' );
		    canvas.width = img.width;
		    canvas.height = img.height;
		    var context = canvas.getContext( '2d' );

		    var size = img.width * img.height;
		    var data = new Float32Array( size );

		    context.drawImage(img,0,0);
				scene.background = new THREE.Color( 0x97DBD1 );
		    for ( var i = 0; i < size; i ++ ) {
		        data[i] = 0
		    }

		    var imgd = context.getImageData(0, 0, img.width, img.height);
		    var pix = imgd.data;

		    var j=0;
		    for (var i = 0; i<pix.length; i +=4) {
		        var all = pix[i]+pix[i+1]+pix[i+2];  // all is in range 0 - 255*3
		        data[j++] = scale*all/3;
		    }

		    return data;
		}

		function Start() {
			sea=[];
			coast=[];
			angle=0;
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0xf0f0f0 );
			document.body.appendChild( renderer.domElement );

			clock = new THREE.Clock();
			time = clock.getElapsedTime();


			camera.position.set(71.7645,10.26048,64,1695);
			camera.lookAt( new THREE.Vector3(0,0,0));

			controls = new THREE.OrbitControls( camera, renderer.domElement );


			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );

			// uncomment if you need to draw coordinate axes when building the scene
			//Coordinates.drawAllAxes();




			// terrain
		  var img = new Image();
		  img.onload = function () {

		      //get height data from img
		    var data = getHeightData(img,0.3);
				createTerrain(data);
				foam = buildFoam(coast);

		  };
		  // load img source
		  img.src = "textures/TerrainLow.jpg";



		}

		function createTerrain(data){
			var size = data.length;
			var acapo =  Math.sqrt(size);

			var x = 0 ;
			var y = 0	;

			for(var i=0;i<size;i++){

				var cube = buildCube(data[i]);

				scene.add(cube);
				cube.position.set(x,data[i]/4,y);
				x++;

				if(x==acapo){
					x=0;
					y++;}
				}

		}

		function buildCube(value){

			var color;
			var isSea = false;

			var isCoast = false;

			if(value<=1){
				var col = getRndInteger(180,200);
				color= new THREE.Color("rgb(0,0,"+col+")");
				isSea = true;

			}else if(value<=3 && value>1){
				var col = getRndInteger(220,255);
				color= new THREE.Color("rgb(0,0,"+col+")");
				isSea = true;


			}else if(value<=5 && value>3){
				var col = getRndInteger(180,200);
				color= new THREE.Color("rgb(0,"+col+","+col+")");
				isCoast = true;

			}else if(value<=6 && value>5){
				var col1 = getRndInteger(190,205);
				var col2 = getRndInteger(170,195);
				var col3 = getRndInteger(100,115);
				color= new THREE.Color("rgb("+col1+","+col2+","+col3+")");


			}else  if(value<=9 && value>6){
				var col1 = getRndInteger(220,240);
				var col2 = getRndInteger(202,222);
				var col3 = getRndInteger(82,102);
				color= new THREE.Color("rgb("+col1+","+col2+","+col3+")");

			}else  if(value<=12 && value>9){

				var col = getRndInteger(201,241);
				color= new THREE.Color("rgb(0,"+col+",0)");

			}else  if(value<=13 && value>12){

				var col = getRndInteger(171,201);
				color= new THREE.Color("rgb(0,"+col+",0)");

			}else  if(value<=17.5 && value>13){

				var col = getRndInteger(64,84);
				color= new THREE.Color("rgb(122,"+col+",28)");

			}else  if(value<=22 && value>17.5){

				var col = getRndInteger(38,47);
				color= new THREE.Color("rgb(82,"+col+",29)");

			}else  if(value<=23 && value>22){
				color= new THREE.Color("rgb(95, 143, 91)");

			}else  if(value<=30.5 && value>23){

				var col1 = getRndInteger(151,154);
				var col2 = col1-17;
				var col3 = col1-26;
				color= new THREE.Color("rgb("+col1+","+col2+","+col3+")");

			}else  if(value<=36 && value>30.5){new THREE.Color("rgb(255, 255, 255)");}

			var mat = new THREE.MeshBasicMaterial({color: color});

			var geo = new THREE.BoxBufferGeometry(1,1,1);

			var cube = new THREE.Mesh(geo,mat);
			if(isSea){
				sea.push(cube);
			}else if(isCoast){
				coast.push(cube);
			}

			return cube;
		}



		function buildFoam(object){
			var foam=[];

			for(var i=0;i<object.length;i++){
				var frag=object[i];


				for(var j=0;j<4;j++){

					var col = getRndInteger(190,210);
					color= new THREE.Color("rgb("+col+","+col+","+col+")");
					var mat = new THREE.MeshBasicMaterial({color: color});

					var random = getRndInteger(0,3);
					var ran = random/10;
					var geo = new THREE.BoxBufferGeometry(0.45,0.5,0.45);
					var cube = new THREE.Mesh(geo,mat);
					if(j==0){
						cube.position.set(frag.position.x + 0.25+1,frag.position.y+ran, frag.position.z + 0.25);
					}else if(j==1){
						cube.position.set(frag.position.x + 0.25+1,frag.position.y+ran, frag.position.z - 0.25);
					}else if(j==2){
						cube.position.set(frag.position.x - 0.25+1,frag.position.y+ran, frag.position.z - 0.25);
					}else{
						cube.position.set(frag.position.x - 0.25+1,frag.position.y+ran, frag.position.z + 0.25);
					}
					scene.add(cube);
					foam.push(cube);
				}}
			return foam;

		}



		function move(angle,height,object){

			for(var i=0;i<object.length;i++){
				var frag= object[i];
				frag.position.y+= Math.sin(angle + frag.position.x*height);
			}
		}

		function moveFoam(angle,object){
			for(var i=0;i<object.length;i++){
				var frag = object[i];
				frag.position.y+= 0.1*Math.sin(angle);
			}

		}

		function getRndInteger(min, max) {
			return Math.floor(Math.random() * (max - min + 1) ) + min;
		}



		function Update() {
			requestAnimationFrame( Update );
			controls.update();
			var now = clock.getElapsedTime();

			if(now>time+0.12){


				move(angle,0.25,sea);
				moveFoam(angle,foam);
				angle++;
				time= now;

			}
			stats.update();
			Render();
		}

		function Render() {

			renderer.render(scene, camera);
		}

		Start();
		Update();

		</script>
	</body>
</html>
